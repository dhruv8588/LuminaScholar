{% extends 'base.html' %}
{% load custom_filters %} 

{% block content %}

<style>
  .page-item.active .page-link {
    columns: #fff;
    background-color: #6c757d;
    border: 1px solid #6c757d;
}

.pagination > li > a {
    background-color: #fff;
    color: #6c757d;
}

.pagination > li > a:focus,
.pagination > li > a:hover,
.pagination > span > a:focus,
.pagination > span > a:hover {
    color: #111;
    background-color: #d3d3d3;
    border: 1px solid #6c757d;
    box-shadow: none;
}

/* paginator */
.dataTables_paginate {
    margin-top: -30px !important;
}

/* Input Search */
.dataTables_filter {
    display: none;
}

/* Show entries */
.dataTables_length {
    float: right !important;
    margin-top: 10px ! important;

}

.dt-buttons {
    margin-bottom: 10px !important;
}

thead input {
    width: 100%;
    text-align: center;
}
</style>



{% for paper in page_obj %}
<h3>Assign REV</h3>
<div class="card" style="max-width: 42rem; margin-left: 400px;">
    <div class="card-header text-secondary" style="padding: 30px;">
        <table class="table table-bordered" style="width: 600px;">
            <thead class="table-active">
              <tr>
                <th scope="col">FIELD</th>
                <th scope="col">DETAILS</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>ID</th>
                <td>{{ paper.journal_id }}</td>
              </tr>
              <tr>
                <th>Title</th>
                <td>{{ paper.title }}</td>
              </tr>
              <tr>
                <th>Submitting Author</th>
                <td>{{ paper.submitter.first_name }} {{ paper.submitter.last_name }}</td>
              </tr>
              <tr>
                <th>Type</th>
                <td>{{ paper.type }}</td>
              </tr>
              <tr>
                <th>Date Submitted</th>
                <td>{{ paper.date_submitted }}</td>
              </tr>
            </tbody>    
        </table>
       
        <a href="{% url 'merge_pdfs' paper.id %}" target="_blank"><i class="fas fa-file-alt"></i> Submission</a>
        <a href="#" data-toggle="modal" data-target="#OriginalFiles"><i class="fa fa-file-alt"></i> Original Files</a>
        {% if paper.cover_letter or paper.cover_letter_file %}
            <a href="#" data-toggle="modal" data-target="#CoverLetter"><i class="fas fa-file-pen"></i> Cover Letter</a>
        {% else %}    
            <a href="#" data-toggle="modal" data-target="#CoverLetter" style="pointer-events: none; opacity: .4;"><i class="fas fa-file-pen"></i> Cover Letter</a>
        {% endif %}
        <a href="#" data-toggle="modal" data-target="#Abstract"><i class="fa fa-pen"></i> Abstract</a>
    
    </div>
    <div class="card-body text-secondary">
            <h5 class="card-title">Reviewer List:</h5>
            <p class="card-text">
                <table class="table table-bordered">
                    <thead class="table-info">
                        <tr>
                            <th scope="col">Order</th>
                            <th scope="col">Name</th>
                            <th scope="col">Status</th>
                            <th scope="col">Remove</th>
                         </tr>  
                    </thead>
                    <tbody>
                        {% for reviewer in paper.reviewers.all %}
                            <tr>
                                <th scope="row">{{ forloop.counter }}</th>
                                <td>
                                    {{ reviewer.first_name }} {{  reviewer.last_name }}
                                </td>
                                <td>
                                    
                                </td>            
                                <td>
                                    <i class="fas fa-trash"></i>
                                </td>    
                            </tr>
                        {% endfor %}    
                    </tbody>
                  </table> 
            </p>
    </div>
  </div>

  <div class="card border-secondary mb-3" style="max-width: 18rem;">
    <h5 class="card-header text-secondary">Progress</h5>
    <div class="card-body" id="progress">
      <form hx-post="{% url 'change_req_reviews' paper.id %}" hx-target='#progress'>
        {% csrf_token %}
        <table class="table table-bordered">
            <tbody>
              <tr>
                <th class="text-secondary"># reviews required to make decision</th>
                <td><input type="number" value="{{ paper.required_reviews }}" style="width: 50px;" name="required_reviews"></input></td>
              </tr>
              <tr>
                <th class="text-secondary"># active selections</th>
                <td>{{ paper.reviewers.count }}</td>
              </tr>
              <tr>
                <th class="text-secondary"># invited</th>
                <td></td>
              </tr>
              <tr>
                <th class="text-secondary"># agreed</th>
                <td></td>
              </tr>
              <tr>
                <th class="text-secondary"># declined</th>
                <td></td>
              </tr>
            </tbody>    
        </table> 
      <div style="display: inline-block; float: right;">  
        <button type="submit" class="btn btn-secondary btn-sm"><i class="fa-solid fa-check"></i> Save</button> 
      </div>  
    </form> 
    </div>
  </div>

<!-- Modal -->
<div class="modal fade" id="OriginalFiles" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Original Files</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <ol>
                {% for file in paper.files.all %}
                    <li><a href="{{ file.file.url }}">{{ file|basename }}</a><br/></li>
                {% endfor %}
            </ol>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" style="display: inline-block; float: right;" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal End -->

  <!-- Modal -->
<div class="modal fade" id="Abstract" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Abstract</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            {{ paper.abstract }}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" style="display: inline-block; float: right;" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal End -->

  <!-- Modal -->
<div class="modal fade" id="CoverLetter" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cover Letter</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            {% if paper.cover_letter %}
                {{ paper.cover_letter }}<br/><br/>
            {% endif %}
            {% if paper.cover_letter_file %}
                <b>Attached Files:</b><br/>
                <a href="{{ paper.cover_letter_file.url }}">{{ paper.cover_letter_file|basename }}</a>
            {% endif %}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" style="display: inline-block; float: right;" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal End -->

  {% endfor %}

<br/>  


<h4>Potential Reviewers</h4>

<div style="display: inline-block; float: left;">  
  <a href="{% url 'awaiting_rev_selection' %}" class="btn btn-dark" style="margin-left: 400px;"><i class="fas fa-angle-left"></i>&nbsp;Back</a>
</div>

{% comment %} <div style="display: inline-block; float: right;">    
{% if page_obj.has_other_pages %}
    <ul class="pagination" style="margin-right: 465px;">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a href="{% url 'assign_rev' paper.id 1 %}" class="btn btn-outline-secondary">First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="{% url 'assign_rev' paper.id page_obj.previous_page_number %}">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled"></li>
        {% endif %}

        {% for i in page_obj.paginator.page_range %}
            {% if page_obj.number == i %}
                <li class="page-item active">
                    <span class="page-link">{{ i }}<span class="sr-only">(current)</span></span>
                </li>
            {% else %}
                <li class="page-item">
                    <a class="page-link" href="{% url 'assign_rev' paper.id i %}">{{ i }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="{% url 'assign_rev' paper.id page_obj.next_page_number %}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a href="{% url 'assign_rev' paper.id page_obj.paginator.num_pages %}" class="btn btn-outline-secondary">Last</a>
            </li>
        {% else %}
            <li class="page-item disabled"></li>
        {% endif %}
    </ul>
{% endif %}
</div>   {% endcomment %}





<br/><br/><br/>
<div class="container">
  <input class="form-control" type="search" id="search" placeholder="Global search..." aria-label="Search">
  <table class="table table-bordered" id="add-reviewer" style="text-align: center;">
      <thead class="table-success">
          <tr>
              <th style="width: 5%;">#</th>
              <th style="width: 17%;">Name</th>
              <th style="width: 20%;">Email</th>
              <th style="width: 10%;">Roles</th>
              <th style="width: 20%;">Institution</th>
              <th style="width: 20%;">Research Areas</th>
              <th style="width: 8%;"></th>
          </tr>
      </thead>
      {% for user in users %}
          <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ user.first_name }} {{ user.last_name }}</td>
              <td><a href="mailto:{{ user.email }}">{{ user.email }}</a></td>
              <td>{% for role in user.roles.all %}{{ role.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
              <td>
                {{ user.institution }}{% if user.city %}, {{ user.city }}{% endif %}{% if user.state  %}, {{ user.state }}{% endif %}, {{ user.country }}
              </td>
              <td>
                {% for researchArea in user.researchAreas.all %}{{ researchArea.name }}{% if not forloop.last %}, {% endif %}{% endfor %},
                {% for additionalResearchArea in user.additionalResearchAreas.all %}{{ additionalResearchArea.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
              </td>
              <td><a href="#" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Add</a></td>
          </tr>
      {% endfor %}    
  </table>            
</div>

<br/><br/><br/>


<!-- Datatables script -->
<script>
  $(document).ready(function() {
      $('#add-reviewer thead tr')
          .clone(true)
          .addClass('filters')
          .appendTo('#add-reviewer thead');

      var table = $('#add-reviewer').DataTable({
          // Datatables config
          paging: true, // Pagination
          pageLength: 10, // Data entries per page
          lengthChange: true, // Show entries per page
          autoWidth: false, // Set auto width on columns
          searching: true, // Input global search(filter)
          bInfo: true, // entries info 
          bSort: true, // Sort columns alphabetically and numerically in asc or desc order

          // Disable sort columns
          /* "columnDefs": [{
              // "targets": 5, // 1 column
              "targets": [4, 5], // More than 1 column
              "orderable": false
          }] */

          initComplete: function() {
              var api = this.api();

              // Set the columns you wish filtering
              api
                  .columns([0, 1, 2, 3, 4, 5])
                  .eq(0)
                  .each(function(colIdx) {
                      var cell = $('.filters th').eq(
                          $(api.column(colIdx).header()).index()
                      );
                      var title = $(cell).text();
                      $(cell).html('<input type="text" placeholder="' + title + '"/>');

                      $(
                          'input',
                          $('.filters th').eq($(api.column(colIdx).header()).index())
                      )
                      .off('keyup change')
                      .on('keyup change', function(e) {
                          e.stopPropagation();

                          $(this).attr('title', $(this).val());
                          var regexr = '({search})';

                          var cursorPosition = this.selectionStart;

                          api
                              .column(colIdx)
                              .search(
                                  this.value != ''
                                      ? regexr.replace('{search}', '(((' + this.value + ')))')
                                      : '',
                                  this.value != '',
                                  this.value == ''    
                              )
                          .draw();

                      $(this)
                          .focus()[0]
                          .setSelectionRange(cursorPosition, cursorPosition);

                      });
                  });
          },

           // Buttons 
          dom: 'lBfrtip',
          buttons: [

              {
                  // COPY 
                  extend: 'copy',
                  text: '<i class="fas fa-clone"></i>',
                  className: 'btn btn-secondary',
                  titleAttr: 'Copy',

                  // Choose the columns you wish to copy
                  exportOptions: {
                      columns: [0, 1, 2, 3, 4, 5]
                  },
              },


              {
                  // EXCEL
                  extend: 'excel',
                  text: '<i class="fas fa-file-excel"></i>',
                  className: 'btn btn-secondary',
                  titleAttr: 'Excel',

                  // Choose the columns you wish to export to excel
                  exportOptions: {
                      columns: [0, 1, 2, 3, 4, 5]
                  },
              },

              {
                  // PRINT
                  extend: 'print',
                  text: '<i class="fas fa-print"></i>',
                  className: 'btn btn-secondary',
                  titleAttr: 'Print',

                  // Choose the columns you wish to print
                  exportOptions: {
                      columns: [0, 1, 2, 3, 4, 5]
                  },
                  // Font size (when export to print)
                  customized: function( win ){
                      $(win.document.body).css('font-size', '10pt')
                      $(win.document.body).find('table')
                          .addClass('compact')
                          .css('font-size', 'inherit');
                  }
              },

              {
                  // PDF
                  extend: 'pdf',
                  text: '<i class="fas fa-file-pdf"></i>',
                  className: 'btn btn-secondary',
                  titleAttr: 'PDF',

                  // Choose the columns you wish to export to pdf
                  exportOptions: {
                      columns: [0, 1, 2, 3, 4, 5]
                  },

                  // Center the table
                  tableHeader: {
                      alignment: 'center'

                  },
                  // Font size and optimization
                  customize: function (doc) {
                      doc.styles.tableHeader.alignment = 'center'; // Header position
                      doc.styles.tableBodyOdd.alignment = 'center'; // Body position 1 (grey color)
                      doc.styles.tableBodyEven.alignment = 'center'; // Body position 2 (white color)
                      doc.styles.tableHeader.fontSize = 9; // Header font-size
                      doc.defaultStyle.fontSize = 8; // Body font-size
                      // To get 100% width of the table
                      doc.content[1].table.widths = Array(doc.content[1].table.body[1].length + 1).join('*').split('');
                  }
              },
              
          ]

      });

      // Enable Searchbox Outside
      var newSearch = $("#add-reviewer").DataTable();
      $("#search").keyup(function() {
          newSearch.search($(this).val()).draw();
      }); 
  });
</script>    




{% endblock %}